{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/auth/index.js","webpack:///./src/auth/router.js","webpack:///./src/auth/store.js","webpack:///./src/index.js","webpack:///./src/pet/index.js","webpack:///./src/pet/router.js","webpack:///./src/pet/store.js","webpack:///./src/utils/constants.js","webpack:///./src/utils/index.js","webpack:///./src/utils/middlewares.js","webpack:///./src/utils/wss.js","webpack:///external \"@koa/cors\"","webpack:///external \"fs\"","webpack:///external \"http\"","webpack:///external \"jsonwebtoken\"","webpack:///external \"koa\"","webpack:///external \"koa-bodyparser\"","webpack:///external \"koa-jwt\"","webpack:///external \"koa-router\"","webpack:///external \"nedb-promise\"","webpack:///external \"ws\""],"names":["router","Router","createToken","user","jwt","sign","username","_id","jwtConfig","secret","expiresIn","createUser","response","userStore","insert","body","token","status","err","issue","error","message","post","ctx","request","credentials","findOne","password","UserStore","constructor","filename","autoload","store","dataStore","props","app","Koa","server","http","createServer","callback","wss","WebSocket","Server","initWss","use","cors","timingLogger","exceptionHandler","bodyParser","prefix","publicApiRouter","authRouter","routes","allowedMethods","protectedApiRouter","petRouter","listen","console","log","get","userId","state","page","query","pets","petStore","find","owner","sort","p1","p2","lastModified","lastUpdated","set","result","undefined","i","length","push","pet","ownerName","name","params","id","createPet","version","oldPhoto","photo","imageBuffer","Buffer","from","content","fs","filepath","broadcast","event","payload","put","petId","currentPet","currentPhoto","updatedCount","update","del","remove","PetStore","next","start","Date","now","method","url","value","on","ws","type","JSON","parse","close","verify","data","clients","forEach","client","readyState","OPEN","send","stringify"],"mappings":"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","file":"main.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"/\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 0);\n","export * from './router';","import Router from 'koa-router';\r\nimport userStore from './store';\r\nimport jwt from 'jsonwebtoken';\r\nimport { jwtConfig } from '../utils';\r\n\r\nexport const router = new Router();\r\n\r\nconst createToken = (user) => {\r\n  return jwt.sign({ username: user.username, _id: user._id }, jwtConfig.secret, { expiresIn: 60 * 60 * 60 });\r\n};\r\n\r\nconst createUser = async (user, response) => {\r\n  try {\r\n    await userStore.insert(user);\r\n    response.body = { token: createToken(user) };\r\n    response.status = 201;\r\n  } catch (err) {\r\n    response.body = { issue: [{ error: err.message }] };\r\n    response.status = 400;\r\n  }\r\n};\r\n\r\nrouter.post('/signup', async (ctx) => await createUser(ctx.request.body, ctx.response));\r\n\r\nrouter.post('/login', async (ctx) => {\r\n  const credentials = ctx.request.body;\r\n  const response = ctx.response;\r\n  const user = await userStore.findOne({ username: credentials.username });\r\n  if (user && credentials.password === user.password) {\r\n    response.body = { token: createToken(user) };\r\n    response.status = 201;\r\n  } else {\r\n    response.body = { issue: [{ error: 'Invalid credentials' }] };\r\n    response.status = 400;\r\n  }\r\n});\r\n","import dataStore from 'nedb-promise';\r\n\r\nexport class UserStore {\r\n  constructor({ filename, autoload }) {\r\n    this.store = dataStore({ filename, autoload });\r\n  }\r\n  \r\n  async findOne(props) {\r\n    return this.store.findOne(props);\r\n  }\r\n  \r\n  async insert(user) {\r\n    return this.store.insert(user);\r\n  };\r\n}\r\n\r\nexport default new UserStore({ filename: './db/users.json', autoload: true });","import Koa from 'koa';\nimport WebSocket from 'ws';\nimport http from 'http';\nimport Router from 'koa-router';\nimport bodyParser from \"koa-bodyparser\";\nimport { timingLogger, exceptionHandler, jwtConfig, initWss, verifyClient } from './utils';\nimport { router as petRouter } from './pet';\nimport { router as authRouter } from './auth';\nimport jwt from 'koa-jwt';\nimport cors from '@koa/cors';\n\nconst app = new Koa();\nconst server = http.createServer(app.callback());\nconst wss = new WebSocket.Server({ server });\ninitWss(wss);\n\napp.use(cors());\napp.use(timingLogger);\napp.use(exceptionHandler);\napp.use(bodyParser());\n\nconst prefix = '/api';\n\n// public\nconst publicApiRouter = new Router({ prefix });\npublicApiRouter\n    .use('/auth', authRouter.routes());\napp\n    .use(publicApiRouter.routes())\n    .use(publicApiRouter.allowedMethods());\n\napp.use(jwt(jwtConfig));\n\n// protected\nconst protectedApiRouter = new Router({ prefix });\nprotectedApiRouter\n    .use('/pet', petRouter.routes());\napp\n    .use(protectedApiRouter.routes())\n    .use(protectedApiRouter.allowedMethods());\n\nserver.listen(3000);\nconsole.log('started on port 3000');\n","export * from './router';","import Router from 'koa-router';\r\nimport petStore from './store';\r\nimport userStore from '../auth/store';\r\nimport {broadcast} from \"../utils\";\r\nimport * as fs from \"fs\";\r\n\r\nexport const router = new Router();\r\n\r\nrouter.get('/', async (ctx) => {\r\n    const response = ctx.response;\r\n    const userId = ctx.state.user._id;\r\n    console.log(userId);\r\n    const page = ctx.query.page;\r\n    let pets = await petStore.find({owner: userId});\r\n    pets.sort((p1, p2) => {\r\n        if (p1.lastModified > p2.lastModified) {\r\n            return -1;\r\n        } else if (p1.lastModified === p2.lastModified) {\r\n            return 0;\r\n        }\r\n        return 1;\r\n    })\r\n    let lastUpdated = 0;\r\n    // if (pets.length > 0) {\r\n    //     lastUpdated = pets[0].lastModified;\r\n    //     const ifModifiedSince = ctx.request.get('If-Modified-Since');\r\n    //     if (ifModifiedSince && parseInt(ifModifiedSince) >= lastUpdated) {\r\n    //         ctx.response.status = 304; // NOT MODIFIED\r\n    //         return;\r\n    //     }\r\n    // }\r\n\r\n    ctx.response.set('Last-Modified', lastUpdated);\r\n    let result = [];\r\n    if (page !== undefined) {\r\n        for (let i = 0; i < 6; i++) {\r\n            if (page * 6 + i < pets.length)\r\n                result.push(pets[page * 6 + i]);\r\n        }\r\n    } else {\r\n        result = pets;\r\n    }\r\n    if (result.length > 0) {\r\n        let user = await userStore.findOne({_id: result[0].owner});\r\n        for (let pet of result) {\r\n            pet.ownerName = user.name;\r\n            // if (pet.photo) {\r\n            //     pet.photo = {\r\n            //         filepath: pet.photo,\r\n            //         content: fs.readFileSync(`photos/${pet.photo}`, {encoding: 'base64'})\r\n            //     }\r\n            // }\r\n        }\r\n    }\r\n    response.body = result;\r\n    response.status = 200;\r\n});\r\n\r\nrouter.get('/:id', async (ctx) => {\r\n    const userId = ctx.state.user._id;\r\n    const pet = await petStore.findOne({_id: ctx.params.id});\r\n    const response = ctx.response;\r\n    if (pet) {\r\n        if (pet.owner === userId) {\r\n            let user = await userStore.findOne({_id: pet.owner});\r\n            pet.ownerName = user.name;\r\n            response.body = pet;\r\n            response.status = 200; // ok\r\n        } else {\r\n            response.status = 403; // forbidden\r\n        }\r\n    } else {\r\n        response.status = 404; // not found\r\n    }\r\n});\r\n\r\nconst createPet = async (ctx, pet, response) => {\r\n    try {\r\n        pet.owner = ctx.state.user._id;\r\n        delete pet.ownerName;\r\n        pet.version = 1;\r\n        const oldPhoto = pet.photo;\r\n        if (pet.photo) {\r\n            const imageBuffer = Buffer.from(pet.photo.content, 'base64');\r\n            fs.writeFile(`photos/${pet.photo.filepath}`, imageBuffer, function (err) {\r\n\r\n            });\r\n            pet.photo = pet.photo.filepath;\r\n        }\r\n        pet = await petStore.insert(pet);\r\n        let user = await userStore.findOne({_id: pet.owner});\r\n        pet.ownerName = user.name;\r\n        if (pet.photo) {\r\n            pet.photo = oldPhoto;\r\n        }\r\n        response.body = pet;\r\n        response.status = 201;\r\n        broadcast(pet.owner, {event: 'created', payload: response.body});\r\n    } catch (err) {\r\n        response.body = {message: err.message};\r\n        response.status = 400;\r\n        if (pet.photo) {\r\n            fs.unlink(`photos/${pet.photo.filepath}`, (err) => {\r\n                console.log(err);\r\n            });\r\n        }\r\n    }\r\n};\r\n\r\nrouter.post('/', async ctx => await createPet(ctx, ctx.request.body, ctx.response));\r\n\r\nrouter.put('/:id', async (ctx) => {\r\n        const pet = ctx.request.body;\r\n        const id = ctx.params.id;\r\n        const petId = pet._id;\r\n        const response = ctx.response;\r\n        if (petId && petId !== id) {\r\n            response.body = {message: 'Param id and body _id should be the same'};\r\n            response.status = 400;\r\n            return;\r\n        }\r\n        if (!petId) {\r\n            await createPet(ctx, pet, response);\r\n        } else {\r\n            const userId = ctx.state.user._id;\r\n            if (userId !== pet.owner) {\r\n                response.body = {message: 'Forbidden access to resource'};\r\n                response.status = 403;\r\n            } else {\r\n                let ownerName = pet.ownerName;\r\n                delete pet.ownerName;\r\n                const currentPet = await petStore.findOne({_id: id});\r\n                const currentPhoto = currentPet.photo;\r\n                if (currentPet.version > pet.version) {\r\n                    response.status = 409;\r\n                } else {\r\n                    pet.version += 1;\r\n                    const oldPhoto = pet.photo;\r\n                    if (pet.photo) {\r\n                        const imageBuffer = Buffer.from(pet.photo.content, 'base64');\r\n                        fs.writeFile(`photos/${pet.photo.filepath}`, imageBuffer, function (err) {\r\n\r\n                        });\r\n                        pet.photo = pet.photo.filepath;\r\n                    }\r\n                    const updatedCount = await petStore.update({_id: id}, pet);\r\n                    if (updatedCount === 1) {\r\n                        if (currentPhoto && currentPhoto !== pet.photo) {\r\n                            fs.unlink(`photos/${currentPhoto}`, (err) => {\r\n                                console.log(err);\r\n                            });\r\n                        }\r\n                        pet.ownerName = ownerName;\r\n                        if (oldPhoto) {\r\n                            pet.photo = oldPhoto;\r\n                        }\r\n                        response.body = pet;\r\n                        response.status = 200;\r\n                        broadcast(pet.owner, {event: 'updated', payload: pet});\r\n                    } else {\r\n                        response.body = {message: 'Resource no longer exists'};\r\n                        response.status = 405;\r\n                        if (pet.photo) {\r\n                            fs.unlink(`photos/${pet.photo.filepath}`, () => {\r\n                            });\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n);\r\n\r\nrouter.del('/:id', async (ctx) => {\r\n    // const userId = ctx.state.user._id;\r\n    const pet = await petStore.findOne({_id: ctx.params.id});\r\n    // if (pet && userId !== pet.userId) {\r\n    if (pet) {\r\n        await petStore.remove({_id: ctx.params.id});\r\n        ctx.response.status = 204; // no content\r\n        broadcast(null, {event: 'deleted', payload: pet});\r\n    }\r\n});\r\n","import dataStore from 'nedb-promise';\r\n\r\n\r\nexport class PetStore {\r\n    constructor({filename, autoload}) {\r\n        this.store = dataStore({filename, autoload});\r\n    }\r\n\r\n    async find(props) {\r\n        return this.store.find(props);\r\n    }\r\n\r\n    async findOne(props) {\r\n        return this.store.findOne(props);\r\n    }\r\n\r\n    async insert(pet) {\r\n        delete pet._id;\r\n        return this.store.insert(pet);\r\n    };\r\n\r\n    async update(props, pet) {\r\n        return this.store.update(props, pet);\r\n    }\r\n\r\n    async remove(props) {\r\n        return this.store.remove(props);\r\n    }\r\n}\r\n\r\nexport default new PetStore({filename: './db/pets.json', autoload: true});","export const jwtConfig = { secret: 'my-secret' };\r\n","export * from './constants';\r\nexport * from './middlewares';\r\nexport * from './wss';\r\n","export const exceptionHandler = async (ctx, next) => {\r\n  try {\r\n    return await next();\r\n  } catch (err) {\r\n    console.log(err);\r\n    ctx.body = { message: err.message || 'Unexpected error.' };\r\n    ctx.status = err.status || 500;\r\n  }\r\n};\r\n\r\nexport const timingLogger = async (ctx, next) => {\r\n  const start = Date.now();\r\n  await next();\r\n  console.log(`${ctx.method} ${ctx.url} => ${ctx.response.status}, ${Date.now() - start}ms`);\r\n};\r\n","import WebSocket from \"ws\";\r\nimport jwt from \"jsonwebtoken\";\r\nimport {jwtConfig} from \"./constants\";\r\n\r\nlet wss;\r\n\r\nexport const initWss = value => {\r\n    wss = value;\r\n    wss.on('connection', ws => {\r\n        ws.on('message', message => {\r\n            const {type, payload: {token}} = JSON.parse(message);\r\n            if (type !== 'authorization') {\r\n                ws.close();\r\n                return;\r\n            }\r\n            try {\r\n                ws.user = jwt.verify(token, jwtConfig.secret);\r\n            } catch (err) {\r\n                ws.close();\r\n            }\r\n        })\r\n    });\r\n};\r\n\r\nexport const broadcast = (userId, data) => {\r\n    if (!wss) {\r\n        return;\r\n    }\r\n    wss.clients.forEach(client => {\r\n        // if (client.readyState === WebSocket.OPEN && userId === client.user._id) {\r\n        if (client.readyState === WebSocket.OPEN) {\r\n            console.log(`broadcast sent to ${client.user._id}`);\r\n            client.send(JSON.stringify(data));\r\n        }\r\n    });\r\n};\r\n","module.exports = require(\"@koa/cors\");","module.exports = require(\"fs\");","module.exports = require(\"http\");","module.exports = require(\"jsonwebtoken\");","module.exports = require(\"koa\");","module.exports = require(\"koa-bodyparser\");","module.exports = require(\"koa-jwt\");","module.exports = require(\"koa-router\");","module.exports = require(\"nedb-promise\");","module.exports = require(\"ws\");"],"sourceRoot":""}